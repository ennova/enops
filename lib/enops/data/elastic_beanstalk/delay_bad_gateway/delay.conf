perl_modules /etc/nginx/perl/lib;
perl_require delay.pm;

server {
  listen 8501;
  access_log /var/log/nginx/access-backup.log;
  location / {
    proxy_pass http://delay;
    proxy_http_version 1.1;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Host $host;
  }
}

upstream delay {
  server 127.0.0.1:8502 fail_timeout=30s;
  server 127.0.0.1:80 backup;
}

server {
  listen 8502;
  access_log /var/log/nginx/access-delay.log;
  location / {
    perl delay::handler;
  }
}

proxy_next_upstream error timeout http_502 non_idempotent;
